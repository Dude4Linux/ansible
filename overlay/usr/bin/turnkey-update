#! /bin/bash
# ---------------------------------------------------------------------------
# turnkey-update - Download and apply package updates

# Copyright 2014, John Carver <dude4linux@gmail.com>
  
  # This program is free software: you can redistribute it and/or modify
  # it under the terms of the GNU General Public License as published by
  # the Free Software Foundation, either version 3 of the License, or
  # (at your option) any later version.

  # This program is distributed in the hope that it will be useful,
  # but WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  # GNU General Public License at (http://www.gnu.org/licenses/) for
  # more details.

# Usage: turnkey-update [-h|--help] [-a|--all] [-s|--secure]

# Revision history:
# 2014-07-23 Created by new_script ver. 3.0
# 2015-02-14 Display help even if not root
# 2015-02-15 Generalized to run scripts in /etc/turnkey/update.d/
# ---------------------------------------------------------------------------

PROGNAME=${0##*/}
VERSION="0.3"

UPDATE_DIR="/etc/turnkey/update.d"

clean_up() { # Perform pre-exit housekeeping
  return
}

error_exit() {
  echo -e "${PROGNAME}: ${1:-"Unknown Error"}" >&2
  clean_up
  exit 1
}

graceful_exit() {
  clean_up
  exit
}

signal_exit() { # Handle trapped signals
  case $1 in
    INT)    error_exit "Program interrupted by user" ;;
    TERM)   echo -e "\n$PROGNAME: Program terminated" >&2 ; graceful_exit ;;
    *)      error_exit "$PROGNAME: Terminating on unknown signal" ;;
  esac
}

usage() {
  echo -e "Usage: $PROGNAME [-h|--help] [-a|--all] [-s|--secure]"
}

help_message() {
  cat <<- _EOF_
  $PROGNAME ver. $VERSION
  Download and apply package updates

  $(usage)

  Options:
    -h, --help          Display this help message and exit.
    -a, --all           Apply all updates
    -s, --secure        Apply only security updates (default)

  NOTE: You must be the superuser to run this script.

_EOF_
  return
}

# Trap signals
trap "signal_exit TERM" TERM HUP
trap "signal_exit INT"  INT

all="false";

# Parse command-line
while [[ -n $1 ]]; do
  case $1 in
    -h | --help)        help_message; graceful_exit ;;
    -a | --all)         echo "Apply all updates"; all="true" ;;
    -s | --secure)      echo "Apply only security updates" ;;
    -* | --*)           usage; error_exit "Unknown option $1" ;;
    *)                  echo "Argument $1 to process..." ;;
  esac
  shift
done

# Main logic

# Check for root UID
if [[ $(id -u) != 0 ]]; then
  error_exit "You must be the superuser to run this script."
fi

if [[ $all == "false" ]]; then
  export SEC_UPDATES="FORCE";
  /usr/lib/inithooks/firstboot.d/95secupdates
else
  apt-get update  -qq
  apt-get upgrade -qy
  if [[ -d $UPDATE_DIR ]]; then
    run-parts --lsbsysinit $UPDATE_DIR
  fi
fi

graceful_exit
